     1 00000000                                 [FORMAT "WCOFF"]
     2 00000000                                 [INSTRSET "i486p"]
     3 00000000                                 [OPTIMIZE 1]
     4 00000000                                 [OPTION 1]
     5 00000000                                 [BITS 32]
     6 00000000                                 	EXTERN	_memman_alloc_4k
     7 00000000                                 	EXTERN	_set_segmdesc
     8 00000000                                 	EXTERN	_load_tr
     9 00000000                                 	EXTERN	_timer_alloc
    10 00000000                                 	EXTERN	_timer_settimer
    11 00000000                                 	EXTERN	_farjmp
    12 00000000                                 	EXTERN	_io_hlt
    13 00000000                                 [FILE "multitask.c"]
    14                                          [SECTION .text]
    15 00000000                                 	GLOBAL	_task_init
    16 00000000                                 _task_init:
    17 00000000 55                              	PUSH	EBP
    18 00000001 89 E5                           	MOV	EBP,ESP
    19 00000003 57                              	PUSH	EDI
    20 00000004 56                              	PUSH	ESI
    21 00000005 31 FF                           	XOR	EDI,EDI
    22 00000007 53                              	PUSH	EBX
    23 00000008 31 F6                           	XOR	ESI,ESI
    24 0000000A 68 0001E4B8                     	PUSH	124088
    25 0000000F BB 00000009                     	MOV	EBX,9
    26 00000014 FF 75 08                        	PUSH	DWORD [8+EBP]
    27 00000017 E8 [00000000]                   	CALL	_memman_alloc_4k
    28 0000001C A3 [00000004]                   	MOV	DWORD [_taskCtrl],EAX
    29 00000021 58                              	POP	EAX
    30 00000022 5A                              	POP	EDX
    31 00000023                                 L6:
    32 00000023 89 F8                           	MOV	EAX,EDI
    33 00000025 8D 56 18                        	LEA	EDX,DWORD [24+ESI]
    34 00000028 03 05 [00000004]                	ADD	EAX,DWORD [_taskCtrl]
    35 0000002E 83 C7 78                        	ADD	EDI,120
    36 00000031 C7 80 00000FFC 00000000         	MOV	DWORD [4092+EAX],0
    37 0000003B 89 90 00000FF8                  	MOV	DWORD [4088+EAX],EDX
    38 00000041 05 00001008                     	ADD	EAX,4104
    39 00000046 68 00000089                     	PUSH	137
    40 0000004B 50                              	PUSH	EAX
    41 0000004C 8D 86 00270018                  	LEA	EAX,DWORD [2555928+ESI]
    42 00000052 6A 67                           	PUSH	103
    43 00000054 83 C6 08                        	ADD	ESI,8
    44 00000057 50                              	PUSH	EAX
    45 00000058 E8 [00000000]                   	CALL	_set_segmdesc
    46 0000005D 83 C4 10                        	ADD	ESP,16
    47 00000060 4B                              	DEC	EBX
    48 00000061 79 C0                           	JNS	L6
    49 00000063 8B 0D [00000004]                	MOV	ECX,DWORD [_taskCtrl]
    50 00000069 31 D2                           	XOR	EDX,EDX
    51 0000006B BB 00000009                     	MOV	EBX,9
    52 00000070                                 L11:
    53 00000070 8D 04 11                        	LEA	EAX,DWORD [ECX+EDX*1]
    54 00000073 81 C2 00000198                  	ADD	EDX,408
    55 00000079 4B                              	DEC	EBX
    56 0000007A C7 40 08 00000000               	MOV	DWORD [8+EAX],0
    57 00000081 C7 40 0C 00000000               	MOV	DWORD [12+EAX],0
    58 00000088 79 E6                           	JNS	L11
    59 0000008A E8 0000009D                     	CALL	_task_alloc
    60 0000008F 89 C6                           	MOV	ESI,EAX
    61 00000091 C7 40 04 00000002               	MOV	DWORD [4+EAX],2
    62 00000098 C7 40 0C 00000002               	MOV	DWORD [12+EAX],2
    63 0000009F C7 40 08 00000000               	MOV	DWORD [8+EAX],0
    64 000000A6 50                              	PUSH	EAX
    65 000000A7 E8 00000171                     	CALL	_task_add
    66 000000AC E8 0000025D                     	CALL	_task_switch_preset
    67 000000B1 FF 36                           	PUSH	DWORD [ESI]
    68 000000B3 E8 [00000000]                   	CALL	_load_tr
    69 000000B8 E8 [00000000]                   	CALL	_timer_alloc
    70 000000BD FF 76 0C                        	PUSH	DWORD [12+ESI]
    71 000000C0 50                              	PUSH	EAX
    72 000000C1 A3 [00000000]                   	MOV	DWORD [_taskTimer],EAX
    73 000000C6 E8 [00000000]                   	CALL	_timer_settimer
    74 000000CB E8 0000005C                     	CALL	_task_alloc
    75 000000D0 89 C3                           	MOV	EBX,EAX
    76 000000D2 C7 40 30 [000003B3]             	MOV	DWORD [48+EAX],_task_idle
    77 000000D9 68 00010000                     	PUSH	65536
    78 000000DE FF 75 08                        	PUSH	DWORD [8+EBP]
    79 000000E1 E8 [00000000]                   	CALL	_memman_alloc_4k
    80 000000E6 05 00010000                     	ADD	EAX,65536
    81 000000EB 89 43 48                        	MOV	DWORD [72+EBX],EAX
    82 000000EE C7 43 58 00000008               	MOV	DWORD [88+EBX],8
    83 000000F5 C7 43 5C 00000010               	MOV	DWORD [92+EBX],16
    84 000000FC C7 43 60 00000008               	MOV	DWORD [96+EBX],8
    85 00000103 C7 43 64 00000008               	MOV	DWORD [100+EBX],8
    86 0000010A C7 43 68 00000008               	MOV	DWORD [104+EBX],8
    87 00000111 C7 43 6C 00000008               	MOV	DWORD [108+EBX],8
    88 00000118 6A 01                           	PUSH	1
    89 0000011A 6A 09                           	PUSH	9
    90 0000011C 53                              	PUSH	EBX
    91 0000011D E8 000000A9                     	CALL	_task_run
    92 00000122 8D 65 F4                        	LEA	ESP,DWORD [-12+EBP]
    93 00000125 5B                              	POP	EBX
    94 00000126 89 F0                           	MOV	EAX,ESI
    95 00000128 5E                              	POP	ESI
    96 00000129 5F                              	POP	EDI
    97 0000012A 5D                              	POP	EBP
    98 0000012B C3                              	RET
    99 0000012C                                 	GLOBAL	_task_alloc
   100 0000012C                                 _task_alloc:
   101 0000012C 55                              	PUSH	EBP
   102 0000012D 31 C9                           	XOR	ECX,ECX
   103 0000012F 89 E5                           	MOV	EBP,ESP
   104 00000131 31 D2                           	XOR	EDX,EDX
   105 00000133                                 L22:
   106 00000133 89 D0                           	MOV	EAX,EDX
   107 00000135 03 05 [00000004]                	ADD	EAX,DWORD [_taskCtrl]
   108 0000013B 83 B8 00000FFC 00               	CMP	DWORD [4092+EAX],0
   109 00000142 74 10                           	JE	L25
   110 00000144 41                              	INC	ECX
   111 00000145 83 C2 78                        	ADD	EDX,120
   112 00000148 81 F9 000003E7                  	CMP	ECX,999
   113 0000014E 7E E3                           	JLE	L22
   114 00000150 31 C0                           	XOR	EAX,EAX
   115 00000152                                 L16:
   116 00000152 5D                              	POP	EBP
   117 00000153 C3                              	RET
   118 00000154                                 L25:
   119 00000154 05 00000FF8                     	ADD	EAX,4088
   120 00000159 C7 40 04 00000001               	MOV	DWORD [4+EAX],1
   121 00000160 C7 40 34 00000202               	MOV	DWORD [52+EAX],514
   122 00000167 C7 40 38 00000000               	MOV	DWORD [56+EAX],0
   123 0000016E C7 40 3C 00000000               	MOV	DWORD [60+EAX],0
   124 00000175 C7 40 40 00000000               	MOV	DWORD [64+EAX],0
   125 0000017C C7 40 44 00000000               	MOV	DWORD [68+EAX],0
   126 00000183 C7 40 4C 00000000               	MOV	DWORD [76+EAX],0
   127 0000018A C7 40 50 00000000               	MOV	DWORD [80+EAX],0
   128 00000191 C7 40 54 00000000               	MOV	DWORD [84+EAX],0
   129 00000198 C7 40 58 00000000               	MOV	DWORD [88+EAX],0
   130 0000019F C7 40 5C 00000000               	MOV	DWORD [92+EAX],0
   131 000001A6 C7 40 64 00000000               	MOV	DWORD [100+EAX],0
   132 000001AD C7 40 68 00000000               	MOV	DWORD [104+EAX],0
   133 000001B4 C7 40 6C 00000000               	MOV	DWORD [108+EAX],0
   134 000001BB C7 40 70 00000000               	MOV	DWORD [112+EAX],0
   135 000001C2 C7 40 74 40000000               	MOV	DWORD [116+EAX],1073741824
   136 000001C9 EB 87                           	JMP	L16
   137 000001CB                                 	GLOBAL	_task_run
   138 000001CB                                 _task_run:
   139 000001CB 55                              	PUSH	EBP
   140 000001CC 89 E5                           	MOV	EBP,ESP
   141 000001CE 56                              	PUSH	ESI
   142 000001CF 53                              	PUSH	EBX
   143 000001D0 8B 75 0C                        	MOV	ESI,DWORD [12+EBP]
   144 000001D3 8B 45 10                        	MOV	EAX,DWORD [16+EBP]
   145 000001D6 8B 5D 08                        	MOV	EBX,DWORD [8+EBP]
   146 000001D9 85 F6                           	TEST	ESI,ESI
   147 000001DB 78 3B                           	JS	L31
   148 000001DD                                 L27:
   149 000001DD 85 C0                           	TEST	EAX,EAX
   150 000001DF 7E 03                           	JLE	L28
   151 000001E1 89 43 0C                        	MOV	DWORD [12+EBX],EAX
   152 000001E4                                 L28:
   153 000001E4 83 7B 04 02                     	CMP	DWORD [4+EBX],2
   154 000001E8 74 20                           	JE	L32
   155 000001EA                                 L29:
   156 000001EA 83 7B 04 02                     	CMP	DWORD [4+EBX],2
   157 000001EE 74 0A                           	JE	L30
   158 000001F0 89 73 08                        	MOV	DWORD [8+EBX],ESI
   159 000001F3 53                              	PUSH	EBX
   160 000001F4 E8 00000024                     	CALL	_task_add
   161 000001F9 59                              	POP	ECX
   162 000001FA                                 L30:
   163 000001FA A1 [00000004]                   	MOV	EAX,DWORD [_taskCtrl]
   164 000001FF C6 40 04 01                     	MOV	BYTE [4+EAX],1
   165 00000203 8D 65 F8                        	LEA	ESP,DWORD [-8+EBP]
   166 00000206 5B                              	POP	EBX
   167 00000207 5E                              	POP	ESI
   168 00000208 5D                              	POP	EBP
   169 00000209 C3                              	RET
   170 0000020A                                 L32:
   171 0000020A 39 73 08                        	CMP	DWORD [8+EBX],ESI
   172 0000020D 74 DB                           	JE	L29
   173 0000020F 53                              	PUSH	EBX
   174 00000210 E8 0000003B                     	CALL	_task_remove
   175 00000215 58                              	POP	EAX
   176 00000216 EB D2                           	JMP	L29
   177 00000218                                 L31:
   178 00000218 8B 73 08                        	MOV	ESI,DWORD [8+EBX]
   179 0000021B EB C0                           	JMP	L27
   180 0000021D                                 	GLOBAL	_task_add
   181 0000021D                                 _task_add:
   182 0000021D 55                              	PUSH	EBP
   183 0000021E 89 E5                           	MOV	EBP,ESP
   184 00000220 53                              	PUSH	EBX
   185 00000221 8B 5D 08                        	MOV	EBX,DWORD [8+EBP]
   186 00000224 8B 53 08                        	MOV	EDX,DWORD [8+EBX]
   187 00000227 69 D2 00000198                  	IMUL	EDX,EDX,408
   188 0000022D 03 15 [00000004]                	ADD	EDX,DWORD [_taskCtrl]
   189 00000233 8B 42 08                        	MOV	EAX,DWORD [8+EDX]
   190 00000236 8D 4A 08                        	LEA	ECX,DWORD [8+EDX]
   191 00000239 83 F8 63                        	CMP	EAX,99
   192 0000023C 7F 0F                           	JG	L33
   193 0000023E 89 5C 81 08                     	MOV	DWORD [8+ECX+EAX*4],EBX
   194 00000242 40                              	INC	EAX
   195 00000243 89 42 08                        	MOV	DWORD [8+EDX],EAX
   196 00000246 C7 43 04 00000002               	MOV	DWORD [4+EBX],2
   197 0000024D                                 L33:
   198 0000024D 5B                              	POP	EBX
   199 0000024E 5D                              	POP	EBP
   200 0000024F C3                              	RET
   201 00000250                                 	GLOBAL	_task_remove
   202 00000250                                 _task_remove:
   203 00000250 55                              	PUSH	EBP
   204 00000251 31 C9                           	XOR	ECX,ECX
   205 00000253 89 E5                           	MOV	EBP,ESP
   206 00000255 53                              	PUSH	EBX
   207 00000256 8B 5D 08                        	MOV	EBX,DWORD [8+EBP]
   208 00000259 8B 43 08                        	MOV	EAX,DWORD [8+EBX]
   209 0000025C 69 C0 00000198                  	IMUL	EAX,EAX,408
   210 00000262 03 05 [00000004]                	ADD	EAX,DWORD [_taskCtrl]
   211 00000268 8D 50 08                        	LEA	EDX,DWORD [8+EAX]
   212 0000026B 3B 48 08                        	CMP	ECX,DWORD [8+EAX]
   213 0000026E 7D 0B                           	JGE	L37
   214 00000270                                 L41:
   215 00000270 39 5C 8A 08                     	CMP	DWORD [8+EDX+ECX*4],EBX
   216 00000274 74 05                           	JE	L37
   217 00000276 41                              	INC	ECX
   218 00000277 3B 0A                           	CMP	ECX,DWORD [EDX]
   219 00000279 7C F5                           	JL	L41
   220 0000027B                                 L37:
   221 0000027B 8B 42 04                        	MOV	EAX,DWORD [4+EDX]
   222 0000027E FF 0A                           	DEC	DWORD [EDX]
   223 00000280 39 C1                           	CMP	ECX,EAX
   224 00000282 7D 04                           	JGE	L42
   225 00000284 48                              	DEC	EAX
   226 00000285 89 42 04                        	MOV	DWORD [4+EDX],EAX
   227 00000288                                 L42:
   228 00000288 8B 02                           	MOV	EAX,DWORD [EDX]
   229 0000028A 39 42 04                        	CMP	DWORD [4+EDX],EAX
   230 0000028D 7C 07                           	JL	L43
   231 0000028F C7 42 04 00000000               	MOV	DWORD [4+EDX],0
   232 00000296                                 L43:
   233 00000296 C7 43 04 00000001               	MOV	DWORD [4+EBX],1
   234 0000029D 8B 1A                           	MOV	EBX,DWORD [EDX]
   235 0000029F 39 D9                           	CMP	ECX,EBX
   236 000002A1 7D 0D                           	JGE	L51
   237 000002A3                                 L48:
   238 000002A3 8B 44 8A 0C                     	MOV	EAX,DWORD [12+EDX+ECX*4]
   239 000002A7 89 44 8A 08                     	MOV	DWORD [8+EDX+ECX*4],EAX
   240 000002AB 41                              	INC	ECX
   241 000002AC 39 D9                           	CMP	ECX,EBX
   242 000002AE 7C F3                           	JL	L48
   243 000002B0                                 L51:
   244 000002B0 5B                              	POP	EBX
   245 000002B1 5D                              	POP	EBP
   246 000002B2 C3                              	RET
   247 000002B3                                 	GLOBAL	_task_sleep
   248 000002B3                                 _task_sleep:
   249 000002B3 55                              	PUSH	EBP
   250 000002B4 89 E5                           	MOV	EBP,ESP
   251 000002B6 56                              	PUSH	ESI
   252 000002B7 53                              	PUSH	EBX
   253 000002B8 8B 75 08                        	MOV	ESI,DWORD [8+EBP]
   254 000002BB 83 7E 04 02                     	CMP	DWORD [4+ESI],2
   255 000002BF 74 07                           	JE	L55
   256 000002C1                                 L52:
   257 000002C1 8D 65 F8                        	LEA	ESP,DWORD [-8+EBP]
   258 000002C4 5B                              	POP	EBX
   259 000002C5 5E                              	POP	ESI
   260 000002C6 5D                              	POP	EBP
   261 000002C7 C3                              	RET
   262 000002C8                                 L55:
   263 000002C8 E8 00000024                     	CALL	_task_current
   264 000002CD 56                              	PUSH	ESI
   265 000002CE 89 C3                           	MOV	EBX,EAX
   266 000002D0 E8 FFFFFF7B                     	CALL	_task_remove
   267 000002D5 59                              	POP	ECX
   268 000002D6 39 DE                           	CMP	ESI,EBX
   269 000002D8 75 E7                           	JNE	L52
   270 000002DA E8 0000002F                     	CALL	_task_switch_preset
   271 000002DF E8 0000000D                     	CALL	_task_current
   272 000002E4 FF 30                           	PUSH	DWORD [EAX]
   273 000002E6 6A 00                           	PUSH	0
   274 000002E8 E8 [00000000]                   	CALL	_farjmp
   275 000002ED 58                              	POP	EAX
   276 000002EE 5A                              	POP	EDX
   277 000002EF EB D0                           	JMP	L52
   278 000002F1                                 	GLOBAL	_task_current
   279 000002F1                                 _task_current:
   280 000002F1 A1 [00000004]                   	MOV	EAX,DWORD [_taskCtrl]
   281 000002F6 55                              	PUSH	EBP
   282 000002F7 89 E5                           	MOV	EBP,ESP
   283 000002F9 5D                              	POP	EBP
   284 000002FA 8B 10                           	MOV	EDX,DWORD [EAX]
   285 000002FC 69 D2 00000198                  	IMUL	EDX,EDX,408
   286 00000302 8D 44 02 08                     	LEA	EAX,DWORD [8+EDX+EAX*1]
   287 00000306 8B 50 04                        	MOV	EDX,DWORD [4+EAX]
   288 00000309 8B 44 90 08                     	MOV	EAX,DWORD [8+EAX+EDX*4]
   289 0000030D C3                              	RET
   290 0000030E                                 	GLOBAL	_task_switch_preset
   291 0000030E                                 _task_switch_preset:
   292 0000030E 55                              	PUSH	EBP
   293 0000030F 31 C9                           	XOR	ECX,ECX
   294 00000311 89 E5                           	MOV	EBP,ESP
   295 00000313 A1 [00000004]                   	MOV	EAX,DWORD [_taskCtrl]
   296 00000318 31 D2                           	XOR	EDX,EDX
   297 0000031A                                 L63:
   298 0000031A 83 7C 10 08 00                  	CMP	DWORD [8+EAX+EDX*1],0
   299 0000031F 7F 0C                           	JG	L59
   300 00000321 41                              	INC	ECX
   301 00000322 81 C2 00000198                  	ADD	EDX,408
   302 00000328 83 F9 09                        	CMP	ECX,9
   303 0000032B 7E ED                           	JLE	L63
   304 0000032D                                 L59:
   305 0000032D 89 08                           	MOV	DWORD [EAX],ECX
   306 0000032F C6 40 04 00                     	MOV	BYTE [4+EAX],0
   307 00000333 5D                              	POP	EBP
   308 00000334 C3                              	RET
   309 00000335                                 	GLOBAL	_task_switch
   310 00000335                                 _task_switch:
   311 00000335 55                              	PUSH	EBP
   312 00000336 89 E5                           	MOV	EBP,ESP
   313 00000338 56                              	PUSH	ESI
   314 00000339 53                              	PUSH	EBX
   315 0000033A 8B 1D [00000004]                	MOV	EBX,DWORD [_taskCtrl]
   316 00000340 8B 13                           	MOV	EDX,DWORD [EBX]
   317 00000342 69 D2 00000198                  	IMUL	EDX,EDX,408
   318 00000348 8D 14 1A                        	LEA	EDX,DWORD [EDX+EBX*1]
   319 0000034B 8D 4A 08                        	LEA	ECX,DWORD [8+EDX]
   320 0000034E 8B 41 04                        	MOV	EAX,DWORD [4+ECX]
   321 00000351 8B 74 81 08                     	MOV	ESI,DWORD [8+ECX+EAX*4]
   322 00000355 40                              	INC	EAX
   323 00000356 89 41 04                        	MOV	DWORD [4+ECX],EAX
   324 00000359 3B 42 08                        	CMP	EAX,DWORD [8+EDX]
   325 0000035C 74 4C                           	JE	L69
   326 0000035E                                 L66:
   327 0000035E 80 7B 04 00                     	CMP	BYTE [4+EBX],0
   328 00000362 75 2D                           	JNE	L70
   329 00000364                                 L67:
   330 00000364 8B 41 04                        	MOV	EAX,DWORD [4+ECX]
   331 00000367 8B 5C 81 08                     	MOV	EBX,DWORD [8+ECX+EAX*4]
   332 0000036B FF 73 0C                        	PUSH	DWORD [12+EBX]
   333 0000036E FF 35 [00000000]                	PUSH	DWORD [_taskTimer]
   334 00000374 E8 [00000000]                   	CALL	_timer_settimer
   335 00000379 39 F3                           	CMP	EBX,ESI
   336 0000037B 58                              	POP	EAX
   337 0000037C 5A                              	POP	EDX
   338 0000037D 74 0B                           	JE	L65
   339 0000037F FF 33                           	PUSH	DWORD [EBX]
   340 00000381 6A 00                           	PUSH	0
   341 00000383 E8 [00000000]                   	CALL	_farjmp
   342 00000388 5B                              	POP	EBX
   343 00000389 5E                              	POP	ESI
   344 0000038A                                 L65:
   345 0000038A 8D 65 F8                        	LEA	ESP,DWORD [-8+EBP]
   346 0000038D 5B                              	POP	EBX
   347 0000038E 5E                              	POP	ESI
   348 0000038F 5D                              	POP	EBP
   349 00000390 C3                              	RET
   350 00000391                                 L70:
   351 00000391 E8 FFFFFF78                     	CALL	_task_switch_preset
   352 00000396 8B 15 [00000004]                	MOV	EDX,DWORD [_taskCtrl]
   353 0000039C 8B 02                           	MOV	EAX,DWORD [EDX]
   354 0000039E 69 C0 00000198                  	IMUL	EAX,EAX,408
   355 000003A4 8D 4C 10 08                     	LEA	ECX,DWORD [8+EAX+EDX*1]
   356 000003A8 EB BA                           	JMP	L67
   357 000003AA                                 L69:
   358 000003AA C7 41 04 00000000               	MOV	DWORD [4+ECX],0
   359 000003B1 EB AB                           	JMP	L66
   360 000003B3                                 	GLOBAL	_task_idle
   361 000003B3                                 _task_idle:
   362 000003B3 55                              	PUSH	EBP
   363 000003B4 89 E5                           	MOV	EBP,ESP
   364 000003B6                                 L72:
   365 000003B6 E8 [00000000]                   	CALL	_io_hlt
   366 000003BB EB F9                           	JMP	L72
   367 000003BD                                 	GLOBAL	_taskTimer
   368                                          [SECTION .data]
   369 00000000                                 	ALIGNB	4
   370 00000000                                 _taskTimer:
   371 00000000 00 00 00 00                     	RESB	4
   372 00000004                                 	GLOBAL	_taskCtrl
   373                                          [SECTION .data]
   374 00000004                                 	ALIGNB	4
   375 00000004                                 _taskCtrl:
   376 00000004 00 00 00 00                     	RESB	4
